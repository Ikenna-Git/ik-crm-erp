generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
}

enum DealStage {
  PROSPECT
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum TaskStatus {
  OPEN
  DONE
}

enum ContactStatus {
  LEAD
  PROSPECT
  CUSTOMER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum CrmEntity {
  CONTACT
  COMPANY
  DEAL
}

enum CrmFieldType {
  TEXT
  NUMBER
  CURRENCY
  DATE
  SELECT
  MULTISELECT
  CHECKBOX
}

enum PlaybookStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

enum PortalStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

model Org {
  id           String         @id @default(uuid())
  name         String
  theme        String?        @default("light")
  notifyEmail  String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  users        User[]
  contacts     Contact[]
  companies    Company[]
  deals        Deal[]
  tasks        Task[]
  invoices     Invoice[]
  expenses     Expense[]
  positions    Position[]
  employees    Employee[]
  galleryItems GalleryItem[]
  docs         Doc[]
  notifications Notification[]
  auditLogs    AuditLog[]
  decisionTrails DecisionTrail[]
  playbookRuns PlaybookRun[]
  clientPortals ClientPortal[]
  portalUpdates ClientPortalUpdate[]
  portalDocuments ClientPortalDocument[]
  automationWorkflows AutomationWorkflow[]
  webhookEndpoints WebhookEndpoint[]
  crmFields    CrmField[]
}

model User {
  id           String   @id @default(uuid())
  org          Org      @relation(fields: [orgId], references: [id])
  orgId        String
  email        String   @unique
  name         String
  role         Role     @default(USER)
  passwordHash String?
  title        String?
  phone        String?
  timezone     String?  @default("Africa/Lagos")
  locale       String?  @default("en-NG")
  emailVerified DateTime?
  image         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tasks   Task[]
  deals   Deal[]
  contacts Contact[]
  companies Company[]
  settings UserSettings?
  notifications Notification[]
  auditLogs AuditLog[]
  decisionTrails DecisionTrail[]
  playbookRuns PlaybookRun[]
  automationWorkflows AutomationWorkflow[]
  portalUpdates ClientPortalUpdate[]
  accounts Account[]
  sessions Session[]
  @@index([orgId])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  oauth_token_secret String?
  oauth_token       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model UserSettings {
  id                    String   @id @default(uuid())
  user                  User     @relation(fields: [userId], references: [id])
  userId                String   @unique
  theme                 String   @default("dark")
  density               String   @default("comfortable")
  currency              String   @default("NGN")
  landing               String   @default("dashboard")
  dateFormat            String   @default("DD/MM/YYYY")
  aiProvider            String   @default("auto")
  kpiLayout             Json?
  crmContactView        Json?
  crmCompanyView        Json?
  crmDealView           Json?
  emailNotifications    Boolean  @default(true)
  productNotifications  Boolean  @default(true)
  securityNotifications Boolean  @default(true)
  reminderNotifications Boolean  @default(true)
  marketingNotifications Boolean @default(false)
  smsNotifications      Boolean  @default(false)
  digestEnabled         Boolean  @default(false)
  digestDay             String   @default("MONDAY")
  digestTime            String   @default("08:00")
  digestEmail           String?
  onboarding            Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Contact {
  id        String   @id @default(uuid())
  org       Org      @relation(fields: [orgId], references: [id])
  orgId     String
  name      String
  email     String
  phone     String?
  status    ContactStatus @default(LEAD)
  revenue   Int?
  lastContact DateTime?
  notes     String?
  tags      String?
  customFields Json?
  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?
  owner     User?    @relation(fields: [ownerId], references: [id])
  ownerId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deals Deal[]
  @@index([orgId])
}

model Company {
  id        String    @id @default(uuid())
  org       Org       @relation(fields: [orgId], references: [id])
  orgId     String
  name      String
  industry  String?
  size      String?
  customFields Json?
  owner     User?     @relation(fields: [ownerId], references: [id])
  ownerId   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  contacts Contact[]
  deals    Deal[]
  @@index([orgId])
}

model Deal {
  id            String     @id @default(uuid())
  org           Org        @relation(fields: [orgId], references: [id])
  orgId         String
  title         String
  value         Int
  stage         DealStage  @default(PROSPECT)
  expectedClose DateTime?
  customFields  Json?
  company       Company?   @relation(fields: [companyId], references: [id])
  companyId     String?
  contact       Contact?   @relation(fields: [contactId], references: [id])
  contactId     String?
  owner         User?      @relation(fields: [ownerId], references: [id])
  ownerId       String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  tasks Task[]
  @@index([orgId])
  @@index([stage])
}

model CrmField {
  id        String        @id @default(uuid())
  org       Org           @relation(fields: [orgId], references: [id])
  orgId     String
  entity    CrmEntity
  name      String
  key       String
  type      CrmFieldType
  options   Json?
  required  Boolean       @default(false)
  archived  Boolean       @default(false)
  order     Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([orgId, entity])
  @@unique([orgId, entity, key])
}

model Task {
  id          String     @id @default(uuid())
  org         Org        @relation(fields: [orgId], references: [id])
  orgId       String
  title       String
  dueDate     DateTime?
  status      TaskStatus @default(OPEN)
  relatedType String?
  relatedId   String?
  owner       User?      @relation(fields: [ownerId], references: [id])
  ownerId     String?
  deal        Deal?      @relation(fields: [dealId], references: [id])
  dealId      String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([orgId])
}

model Invoice {
  id            String         @id @default(uuid())
  org           Org            @relation(fields: [orgId], references: [id])
  orgId         String
  invoiceNumber String
  clientName    String
  amount        Int
  status        InvoiceStatus  @default(DRAFT)
  issueDate     DateTime?
  dueDate       DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([orgId, invoiceNumber])
  @@index([orgId])
}

model Expense {
  id          String   @id @default(uuid())
  org         Org      @relation(fields: [orgId], references: [id])
  orgId       String
  description String
  amount      Int
  category    String
  status      ExpenseStatus @default(PENDING)
  submittedBy String?
  date        DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orgId])
}

model Position {
  id        String     @id @default(uuid())
  org       Org        @relation(fields: [orgId], references: [id])
  orgId     String
  title     String
  department String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  employees Employee[]
  @@index([orgId])
}

model Employee {
  id         String    @id @default(uuid())
  org        Org       @relation(fields: [orgId], references: [id])
  orgId      String
  name       String
  email      String?
  phone      String?
  department String?
  position   Position? @relation(fields: [positionId], references: [id])
  positionId String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([orgId])
}

model GalleryItem {
  id          String   @id @default(uuid())
  org         Org      @relation(fields: [orgId], references: [id])
  orgId       String
  title       String
  url         String
  mediaType   String   // image | video | other
  description String?
  size        Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orgId])
}

model Doc {
  id        String   @id @default(uuid())
  org       Org      @relation(fields: [orgId], references: [id])
  orgId     String
  title     String
  category  String?
  content   String
  mediaUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
}

model Notification {
  id        String           @id @default(uuid())
  org       Org              @relation(fields: [orgId], references: [id])
  orgId     String
  user      User?            @relation(fields: [userId], references: [id])
  userId    String?
  type      NotificationType @default(INFO)
  title     String
  message   String
  source    String?
  channel   String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([read])
}

model DecisionTrail {
  id          String   @id @default(uuid())
  org         Org      @relation(fields: [orgId], references: [id])
  orgId       String
  user        User?    @relation(fields: [userId], references: [id])
  userId      String?
  action      String
  entity      String
  entityId    String?
  before      Json?
  after       Json?
  metadata    Json?
  rolledBackAt DateTime?
  createdAt   DateTime @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([createdAt])
}

model PlaybookRun {
  id         String         @id @default(uuid())
  org        Org            @relation(fields: [orgId], references: [id])
  orgId      String
  user       User?          @relation(fields: [userId], references: [id])
  userId     String?
  templateId String
  name       String
  category   String
  status     PlaybookStatus @default(ACTIVE)
  progress   Int            @default(0)
  notes      String?
  startedAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([orgId])
  @@index([userId])
}

model ClientPortal {
  id           String       @id @default(uuid())
  org          Org          @relation(fields: [orgId], references: [id])
  orgId        String
  name         String
  contactName  String?
  contactEmail String?
  status       PortalStatus @default(ACTIVE)
  accessCode   String       @unique
  summary      String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  updates      ClientPortalUpdate[]
  documents    ClientPortalDocument[]

  @@index([orgId])
}

model ClientPortalUpdate {
  id        String   @id @default(uuid())
  org       Org      @relation(fields: [orgId], references: [id])
  orgId     String
  portal    ClientPortal @relation(fields: [portalId], references: [id], onDelete: Cascade)
  portalId  String
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  title     String
  message   String?
  status    String?
  createdAt DateTime @default(now())

  @@index([orgId])
  @@index([portalId])
}

model ClientPortalDocument {
  id        String   @id @default(uuid())
  org       Org      @relation(fields: [orgId], references: [id])
  orgId     String
  portal    ClientPortal @relation(fields: [portalId], references: [id], onDelete: Cascade)
  portalId  String
  title     String
  url       String
  fileType  String?
  bytes     Int?
  createdAt DateTime @default(now())

  @@index([orgId])
  @@index([portalId])
}

model AutomationWorkflow {
  id        String   @id @default(uuid())
  org       Org      @relation(fields: [orgId], references: [id])
  orgId     String
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  name      String
  trigger   String
  action    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([userId])
}

model WebhookEndpoint {
  id        String   @id @default(uuid())
  org       Org      @relation(fields: [orgId], references: [id])
  orgId     String
  name      String
  url       String
  events    Json?
  secret    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
}

model AuditLog {
  id        String   @id @default(uuid())
  org       Org      @relation(fields: [orgId], references: [id])
  orgId     String
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String
  entity    String?
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([createdAt])
}
